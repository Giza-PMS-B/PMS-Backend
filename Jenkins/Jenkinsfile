pipeline {
    agent any

    environment {
        // Git
        REPO_URL = 'https://github.com/Giza-PMS-B/PMS-Backend.git'
        BRANCH   = 'jenkins-pipeline-fix'

        // Deployment (local machine)
        DEPLOY_PATH = '/var/www/pms-backend'

        // Docker Compose env vars (will be injected from Jenkins credentials)
        BOOKING_DB_CONNECTION  = credentials('BOOKING_DB_CONNECTION')
        INVOICE_DB_CONNECTION = credentials('INVOICE_DB_CONNECTION')
        SITE_DB_CONNECTION    = credentials('SITE_DB_CONNECTION')
    }

    triggers {
        githubPush()
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: "${BRANCH}",
                    url: "${REPO_URL}",
                    credentialsId: 'GitHub-omar'
            }
        }

        stage('Restore & Build .NET') {
            steps {
                sh '''
                    dotnet --version
                    dotnet restore PMS.sln
                    dotnet build PMS.sln -c Release
                    dotnet publish PMS.sln -c Release -o publish
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh 'docker compose build'
            }
        }

        stage('Docker Deploy (Localhost)') {
            steps {
                sh '''
                    docker compose down
                    docker compose up -d
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Backend deployed successfully'
        }
        failure {
            echo '❌ Pipeline failed'
        }
    }
}

